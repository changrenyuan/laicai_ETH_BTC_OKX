# 交易系统方案核心共识

本文档整理了两位顾问针对交易系统方案的核心共识，明确了系统的核心定位、架构设计、执行原则与红线规则，作为后续工程开发的核心指导依据。

## 一、核心定位共识
你最适合的交易模式并非「预测行情 / 赌涨跌」，而是以**结构性套利**为核心，做「规则化、工程化」的风险管理者与系统维护者，本质是利用市场结构和赌徒的错误获利（「开赌场收租」而非「当赌徒」）。

## 二、核心架构共识
### 1. 第一层：核心地基（占比 70%-80%，长期稳定收益）
- **核心策略**：资金费率 / 期限套利（Cash & Carry），方向中性（Delta Neutral）。
- **操作逻辑**：
  - 现货与永续合约对冲（如买 1 个 ETH 现货，开 1 个 ETH 空单），不看行情方向、不预测涨跌；
  - 赚取正资金费率收益（每 8 小时自动获利）；
  - 动态再平衡：监控保证金率，价格暴涨时划转 USDT 补保证金防爆仓，价格暴跌时划转盈利加仓现货复利；
- **核心特征**：允许大资金、长期持有、无需盯盘，是稳定收益的核心来源。
- **收益预期**：年化 10%-30%，低风险、几乎无回撤。

### 2. 第二层：辅助增强（占比 20%-30%，可控增量收益）
- **核心逻辑**：捕捉市场无效波动，低频、轻仓、纪律化交易，拒绝扛单 / 逆趋势。
- **具体形式**：
  - 顾问 1：反情绪、低频轻仓交易（非马丁），不逆大趋势、不连续出手、单边行情不硬做；
  - 顾问 2：趋势过滤网格（Trend-Filtered Grid），仅在震荡市（如 ADX<25）启动中性网格，价格突破网格区间立刻止损熔断。
- **风险特征**：承担连续小止损、踏空趋势的可控风险，仅作为增量收益补充。

### 3. 第三层：明确禁止的红线（永久屏蔽）
双方均明确「封印」以下策略，核心原因是不符合「可解释、可复现、低风险」的核心目标：
- ❌ 马丁格尔（Martingale）/ 加仓摊平（哪怕改良版也禁止）；
- ❌ 不止损的「高胜率策略」、高杠杆裸空 / 裸多（杠杆不超 3 倍）；
- ❌ 高频 / 情绪驱动短线、试图预测 K 线涨跌的「黑盒策略」；
- ❌ 寄望一次行情翻身的赌徒式操作。

## 三、落地执行共识
### 核心优先级
先把「资金费率套利」做成可稳定运行 3-6 个月的自动化系统，这是第一要务。

### 开发原则
1. 聚焦核心策略，不扩策略、不追新玩法、不被外界节奏影响；
2. 利用工程思维做系统抗故障设计（监控熔断、滑点、极端行情）；
3. 代码核心目标是自动化风控与套利（而非预测价格）。

## 四、核心身份与收益逻辑共识
- **核心身份**：不是「交易员」，而是「风险管理者 + 系统维护者」；
- **收益来源**：不是行情涨跌，而是市场结构红利 + 赌徒犯错付出的成本（资金费率、追涨杀跌的无效波动）；
- **核心特质匹配**：契合你「不想赌方向、接受慢 / 低回报、有工程思维、关注系统稳定性」的需求。

## 五、总结
1. 核心策略高度一致：以资金费率套利为绝对核心，网格 / 低频轻交易为辅助，拒绝一切赌徒式策略；
2. 执行原则一致：先落地核心套利系统并稳定运行 3-6 个月，聚焦工程化、自动化、低风险；
3. 核心逻辑一致：放弃行情预测，靠规则和系统赚「确定性的收租钱」，而非「赌涨跌的投机钱」。

---

# 资金费率套利交易系统操作手册

## 📖 简介

本系统是一个基于 Cash & Carry 策略的自动化交易系统，专注于通过资金费率套利获取稳定收益。系统采用方向中性（Delta Neutral）策略，通过现货与永续合约对冲，赚取正资金费率收益。

### 核心特点

- ✅ **方向中性**：不预测行情涨跌，专注于市场结构红利
- ✅ **自动化运行**：全自动监控、开仓、平仓、再平衡
- ✅ **多层级风险控制**：保证金防护、熔断器、流动性检测等
- ✅ **完整监控体系**：健康检查、PnL 跟踪、实时通知
- ✅ **模块化设计**：清晰的代码结构，易于扩展和维护

### 系统架构

```
laicai_funding_engine/
│
├─ config/                     # 🧱 唯一可改参数入口
│   ├─ account.yaml            # 子账户 / 资金比例 / 最大风险
│   ├─ instruments.yaml        # BTC / ETH
│   ├─ strategy.yaml           # 资金费率阈值 / 开关
│   └─ risk.yaml               # 熔断 / 保证金 / 深度 / 滑点
│
├─ core/                       # 🔥 系统内核（不碰交易所）
│   ├─ state_machine.py        # ⭐⭐ 状态机（系统灵魂）
│   ├─ context.py              # 当前账户 / 市场 / 系统快照
│   ├─ scheduler.py            # 8h / 1h / 5min 调度
│   └─ events.py               # 系统事件定义
│
├─ risk/                       # 🔥 第一优先级（任何策略前）
│   ├─ margin_guard.py         # 保证金 / 爆仓防护
│   ├─ fund_guard.py           # ⭐ 资金再平衡 / 自动补保证金
│   ├─ liquidity_guard.py      # 深度 / 滑点 / 插针
│   ├─ circuit_breaker.py      # 连续止损 / 日熔断
│   └─ exchange_guard.py       # 交易所异常 / API错误
│
├─ strategy/                   # 🧠 只表达"要不要做"
│   ├─ cash_and_carry.py       # ⭐ 核心策略（唯一主策略）
│   └─ conditions.py           # 开 / 平 仓条件
│
├─ execution/                  # ✋ 只负责"怎么做"
│   ├─ order_manager.py        # 原子化下单 / 撤单
│   ├─ position_manager.py     # 现货 ↔ 合约 对冲
│   └─ rebalancer.py           # 数量偏差修正
│
├─ exchange/                   # 🔌 交易所适配层
│   ├─ okx_client.py           # REST / WS 封装
│   ├─ market_data.py          # 行情 / 资金费率
│   └─ account_data.py         # 余额 / 仓位
│
├─ monitor/                    # 👀 人机接口
│   ├─ health_check.py         # 系统健康
│   ├─ pnl_tracker.py          # 非方向性 PnL
│   └─ notifier.py             # Telegram / 钉钉
│
├─ scripts/                    # 🛠 运维 & 救命
│   ├─ bootstrap.py            # 启动前自检
│   ├─ close_all.py            # 🔥 一键平仓
│   └─ dry_run.py              # 空跑
│
├─ data/                       # 📦 本地状态
│   ├─ runtime_state.json
│   ├─ trade.db                # SQLite（可选）
│   └─ logs/
│
├─ tests/                      # ✅ 不写测试不上线
│   ├─ test_state.py
│   ├─ test_risk.py
│   └─ test_execution.py
│
├─ main.py                     # ⭐ 唯一入口
└─ README.md                   # 操作手册
```
```
┌──────────────────────────────────────┐
│              启动 main.py            │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【1】启动前自检 bootstrap.py          │
│  - 配置文件是否齐全                  │
│  - API Key 是否存在                  │
│  - 上次是否异常退出                  │
│  - 是否有残留仓位                    │
└───────────────┬──────────────────────┘
                ↓ (失败 → 安全退出)
┌──────────────────────────────────────┐
│【2】加载配置 & 初始化组件             │
│  - config/*.yaml                     │
│  - Logger / Notifier                 │
│  - OKX Client                        │
│  - Risk Guards                       │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【3】连接交易所 & 初始状态拉取         │
│  - 查询账户余额                      │
│  - 查询现货 / 合约仓位               │
│  - 查询当前保证金率                  │
│  - 打印 & 推送「连接成功」            │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【4】构建 Context（系统快照）           │
│  - account_snapshot                  │
│  - market_snapshot                   │
│  - open_positions                    │
│  - last_trade_time                   │
│  - system_state = IDLE               │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【5】注册策略 & 风控模块               │
│  - StrategyManager                   │
│    · cash_and_carry                  │
│    · grid_neutral（可选）             │
│  - RiskManager                       │
│    · margin_guard                    │
│    · circuit_breaker                 │
│    · liquidity_guard                 │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【6】启动 Scheduler（调度器）           │
│  - 每 5min：扫描市场                 │
│  - 每 1h ：检查风控 & PnL             │
│  - 每 8h ：资金费率结算               │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【7】进入 StateMachine 主循环          │
│  当前状态：IDLE / RUNNING / STOPPED  │
└───────────────┬──────────────────────┘
                ↓
════════════════ 主循环（核心）════════════════

┌──────────────────────────────────────┐
│ State = IDLE                          │
│  - Scheduler 触发 scan_event          │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【8】市场扫描（Scanner）               │
│  - 拉行情 / K 线（D / 4H / 15m / 3m） │
│  - 初筛标的（流动性 / 费率）           │
│  - 生成候选列表                       │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【9】策略判断（Strategy）              │
│  - 是否震荡 / 非趋势                 │
│  - 是否情绪过度                      │
│  - 是否满足统计优势                  │
│  - 返回 Signal 或 None               │
└───────────────┬──────────────────────┘
                ↓ (None → 回到 IDLE)
┌──────────────────────────────────────┐
│【10】风控审批（Risk）                 │
│  - 是否允许交易                      │
│  - 本次最大仓位                      │
│  - 止损 / 止盈线                     │
│  - 是否触发熔断                      │
└───────────────┬──────────────────────┘
                ↓ (否决 → 回到 IDLE)
┌──────────────────────────────────────┐
│【11】执行前状态锁定                   │
│  - State → OPENING                   │
│  - 冻结新信号                        │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【12】执行层（Execution）               │
│  - 原子下单（现货 / 合约）             │
│  - 处理跛脚 / 撤单 / 补单             │
│  - 对冲检查                          │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【13】更新 Context & PnL               │
│  - 仓位快照                          │
│  - 浮动盈亏                          │
│  - 记录交易                          │
└───────────────┬──────────────────────┘
                ↓
┌──────────────────────────────────────┐
│【14】恢复 State → IDLE                │
└───────────────┬──────────────────────┘
                ↓
══════════════ 回到主循环 ══════════════

┌──────────────────────────────────────┐
│【异常 / 熔断 / 手动退出】             │
│  - close_all.py                      │
│  - 通知                              │
│  - State → STOPPED                   │
└──────────────────────────────────────┘

```
## 🚀 快速开始

### 1. 环境准备

```bash
# 克隆项目
git clone https://github.com/changrenyuan/laicai_ETH_BTC_OKX.git
cd laicai_ETH_BTC_OKX

# 创建虚拟环境（推荐）
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置 API 密钥

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑 .env 文件，填入你的 OKX API 密钥
nano .env
```

### 3. 配置参数

编辑 `config/` 目录下的配置文件：

- `account.yaml` - 账户和资金配置
- `instruments.yaml` - 交易品种配置
- `strategy.yaml` - 策略参数
- `risk.yaml` - 风险管理参数

### 4. 启动前自检

```bash
# 运行启动前检查
python scripts/bootstrap.py
```

### 5. 空跑测试

```bash
# 先在空跑模式下测试
python scripts/dry_run.py
```

### 6. 启动系统

```bash
# 启动真实交易（确保已设置 dry_run: false）
python main.py
```

## 🛠 运维操作

### 紧急平仓

如遇紧急情况，一键平掉所有持仓：

```bash
python scripts/close_all.py
```

### 查看日志

```bash
# 查看系统日志
tail -f logs/app.log
```

### 运行测试

```bash
# 运行所有测试
python -m pytest tests/

# 或单独运行
python tests/test_state.py
python tests/test_risk.py
python tests/test_execution.py
```

## ⚙️ 配置说明

### 核心配置项

**account.yaml**
- `total_capital`: 总资金（USDT）
- `spot_ratio`: 现货比例
- `futures_ratio`: 合约比例
- `max_position_value`: 单币种最大持仓

**strategy.yaml**
- `enabled`: 策略开关
- `dry_run`: 空跑模式
- `funding_rate_threshold`: 资金费率阈值

**risk.yaml**
- `margin_ratio_warning`: 保证金率警告阈值
- `daily_loss_limit`: 日亏损限额
- `circuit_breaker`: 熔断器配置

## 📊 策略逻辑

### 开仓条件

1. 资金费率为正且在合理范围内（0.01% ~ 1%）
2. 系统未处于紧急状态
3. 保证金充足（> 80%）
4. 无该品种持仓

### 平仓条件

1. 资金费率转负
2. 达到止盈目标（5%）
3. 触发止损（-2%）
4. 系统紧急状态

### 再平衡触发

1. 保证金率低于 80%
2. 现货与合约持仓偏差 > 1%

## 🛡️ 风险控制

### 多层级防护

1. **保证金防护**：实时监控保证金率，自动触发再平衡
2. **资金防护**：自动从现货划转资金到合约
3. **流动性防护**：检测市场深度和滑点
4. **熔断器**：连续亏损或日亏损达到限额时停止交易
5. **交易所防护**：监控 API 错误和异常

### 紧急情况处理

- 保证金率 < 50%：触发紧急平仓
- 连续亏损 3 次：触发熔断
- 日亏损 > $500：触发熔断
- 系统错误：停止所有交易

## 📈 性能预期

- **年化收益**：10% - 30%
- **最大回撤**：< 15%
- **胜率**：> 80%
- **资金占用**：50% 现货 + 50% 合约

## ⚠️ 重要提示

1. **风险提示**：虽然本系统采用低风险策略，但投资有风险，请谨慎操作
2. **测试优先**：务必在空跑模式下测试充分后再启用真实交易
3. **资金管理**：不要投入超过可承受损失的资金
4. **监控维护**：定期查看日志和系统状态
5. **API 安全**：妥善保管 API 密钥，不要泄露
## 进展
```
Phase 1: Infra
- config/*
- logs + notifier
- okx_client (read-only)

Phase 2: Safety
- close_all.py
- exchange_guard.py
- margin_guard.py
- circuit_breaker.py
- （state_machine 空壳）

Phase 3: Core
- 完整 state_machine
- context / events
- bootstrap

Phase 4: Trade
- order_manager (原子)
- cash_and_carry

Phase 5: Auto
- fund_guard
- scheduler
- pnl_tracker
```
## 📞 支持

如有问题，请提交 Issue 或联系开发团队。

## 📄 许可证

MIT License
