```commandline
=═════════════════════════════════════════════
            RUNTIME 主循环（Engine）
══════════════════════════════════════════════

初始化完成 → context.state = IDLE

while True:

┌──────────────────────────────────────┐
│ ① Scheduler Tick                    │
│   - 到达扫描时间？                   │
│   - 到达风控检查时间？               │
│   - 到达持仓管理时间？               │
└───────────────┬──────────────────────┘
                ↓

══════════════════════════════════════════════
                【A】市场扫描层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ② Market Scanner                    │
│  - 拉 K线 (D / 4H / 15m / 3m)        │
│  - 拉 funding / 成交量 / 振幅        │
│  - 初筛流动性 / 交易额               │
│  - 输出：symbol_list                 │
└───────────────┬──────────────────────┘
                ↓

┌──────────────────────────────────────┐
│ ③ Regime Detector                   │
│  - ADX                               │
│  - 波动率扩张                        │
│  - 价格分布结构                      │
│  - 量价结构                          │
│  - 输出：regime_map                  │
│    (trend / range / chaos)           │
└───────────────┬──────────────────────┘
                ↓

══════════════════════════════════════════════
                【B】信号生成层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ④ Strategy Router                   │
│  - 根据 regime 选择策略              │
│    trend  → trend_strategy           │
│    range  → ai_grid_strategy         │
│    chaos  → no trade                 │
│  - 输出：Signal 或 None              │
└───────────────┬──────────────────────┘
                ↓

(None → 回到循环)

══════════════════════════════════════════════
                【C】组合层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ⑤ Portfolio Manager                 │
│  - 是否已有仓位？                    │
│  - 是否冲突？                        │
│  - 是否超标的数量？                  │
│  - 计算建议仓位大小                  │
│  - 输出：Proposed Order              │
└───────────────┬──────────────────────┘
                ↓

══════════════════════════════════════════════
                【D】风控审批层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ⑥ Risk Engine                       │
│  - 是否允许开仓                      │
│  - 本次最大仓位比例                  │
│  - 止损 / 止盈价格                   │
│  - 是否触发熔断                      │
│  - 输出：Approved / Reject           │
└───────────────┬──────────────────────┘
                ↓

(Reject → 回到循环)

══════════════════════════════════════════════
                【E】执行层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ⑦ Execution                         │
│  - 下单（原子化）                    │
│  - 检查成交                          │
│  - 处理跛脚                          │
│  - 更新持仓                          │
└───────────────┬──────────────────────┘
                ↓

══════════════════════════════════════════════
                【F】状态更新层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ⑧ Context Update                    │
│  - 更新 positions                    │
│  - 更新 PnL                          │
│  - 更新 trade_count                  │
│  - 更新 last_trade_time              │
└───────────────┬──────────────────────┘
                ↓

══════════════════════════════════════════════
                【G】分析与展示层
══════════════════════════════════════════════

┌──────────────────────────────────────┐
│ ⑨ Analytics                         │
│  - 记录交易                          │
│  - 统计胜率                          │
│  - 统计收益                          │
│  - 保存到 data/trade.db              │
└───────────────┬──────────────────────┘
                ↓

┌──────────────────────────────────────┐
│ ⑩ Dashboard Update                  │
│  - 显示当前 regime                   │
│  - 显示候选币                        │
│  - 显示当前仓位                      │
│  - 显示浮盈                          │
│  - 显示今日收益                      │
└──────────────────────────────────────┘

回到 while True

```